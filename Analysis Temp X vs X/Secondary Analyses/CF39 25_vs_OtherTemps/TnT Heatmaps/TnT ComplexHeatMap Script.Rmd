---
title: "ComplexHeatMap Test Script"
author: "Trevor Randall"
date: "12/05/2020"
output: html_document
---

Analysis from: https://jokergoo.github.io/ComplexHeatmap-reference/book/a-single-heatmap.html

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Clear Global Environment
```{r}
remove(list = ls())
```


```{r}
#Set Library Directory
#PC Path
.libPaths(c("L:/RStudios/RPackRatLibLocations", "L:/RStudios/RPackRat_2019_04_DESEQLibs"))

#Set working directory
#PC Path
setwd("E:/Dropbox/Dropbox/Harrison Lab - Trevor Randall/RNASeq Analysis/RNASeqAnlyPkrat_2020_03/Analysis Temp X vs X/Secondary Analyses/CF39 25_vs_OtherTemps/TnT Heatmaps")
#Laptop Path
#Set Library Directory
#.libPaths(c(""))
#setwd("")
#sink(file = "./RSessionRawRun.txt") 
``` 


#Libraries required
```{r}
library(readr)
library(ComplexHeatmap)
library(circlize)
library(cluster)
library(dendextend)
#library(seriation)
```

PTA = Pure Temperature Analysis
#Dataset
```{r}
TnT_List_Analysis_Shrunk2 <- read_csv("../TnT CF39 thermoregulation Shrunk2-2.csv")
rawNamesOfColumns <- c("locus", "FoldChange_25vs29", "FoldChange_25vs33", "FoldChange_25vs37", "FoldChange_25vs41", "Gene", "Product", "PAO1_ID", "Protein Description")
colnames(TnT_List_Analysis_Shrunk2) <- rawNamesOfColumns

FoldChangeData <- data.frame(TnT_List_Analysis_Shrunk2$locus, TnT_List_Analysis_Shrunk2$FoldChange_25vs29, TnT_List_Analysis_Shrunk2$FoldChange_25vs33, TnT_List_Analysis_Shrunk2$FoldChange_25vs37, TnT_List_Analysis_Shrunk2$FoldChange_25vs41)
NamesOfColumns <- c("locus", "FoldChange_25vs29", "FoldChange_25vs33", "FoldChange_25vs37", "FoldChange_25vs41")
colnames(FoldChangeData) <- NamesOfColumns
rownames(FoldChangeData) <- FoldChangeData$locus
FoldChangeData <- FoldChangeData[,-1]



FoldChangeDataNoNA <- FoldChangeData
FoldChangeDataNoNA[is.na(FoldChangeDataNoNA)] <- 0
FoldChangeDataNoNAMat <- data.matrix(FoldChangeDataNoNA)
```

```{r}
mat <- FoldChangeDataNoNAMat
colorSetRedBlue <- colorRamp2(c(-10, 0, 10), c(rgb(0, 114/255, 178/255), "white", rgb(213/255, 94/255, 0))) #First color is Blue and second is Vermillion from the Nature Colorblind palette
ColOrder = order(as.numeric(gsub("FoldChange_", "", colnames(mat))))

RowOrder = sort(rownames(mat))
```



#Possible clustering options that i could see

        clustering_distance_rows = "pearson", #Pre-defined distance method (1 - pearson) #Seems to look the most split up along with the single distancing
        clustering_distance_rows = "spearman",
        clustering_distance_rows = "kendall",
        clustering_distance_rows = function(mat) dist(mat), #A function that calculates distance between martix points
        clustering_distance_rows = function(x, y) 1 - cor(x, y), #A function that calculates pairwise distance between martix points
        clustering_method_rows = "single",
        clustering_method_rows = "complete",
        cluster_rows = diana(mat), #Cluster used here
        cluster_rows = function(mat) as.dendrogram(diana(mat)),
        
##TODO Look into Seration package to improve pattern visibility

#Coloration of row dendrigram
```{r}
row_dend = as.dendrogram(hclust(dist(mat, method = "maximum")), method = "complete")
row_dend = color_branches(row_dend, k = 4) # `color_branches()` returns a dendrogram object

split = data.frame(cutree(hclust(dist(mat, method = "maximum")), h=4))

```

  cluster_rows = function(mat) color_branches(as.dendrogram(diana(mat)), k = 10), #Same as above dendrogram
  cluster_rows = function(mat) color_branches(as.dendrogram(diana(mat)), k = 10), #Looks good
  cluster_rows = color_branches(as.dendrogram(hclust(dist(mat, method = "euclidean")), method = "complete"), k = 10) #Looks good
  cluster_rows = color_branches(as.dendrogram(hclust(dist(mat, method = "canberra")), method = "complete"), k = 10) #Looks very logical
  cluster_rows = color_branches(as.dendrogram(hclust(dist(mat, method = "maximum")), method = "complete"), k = 10) #Looks good



```{r}
InCellTextSize = 8
RowLabelTextCell = 10
ColumnLabelText = 10
LegendName = "    Gene \nExpression\n"


HeatmapTest<- Heatmap(
        matrix = mat, 
        #cluster_rows = color_branches(as.dendrogram(hclust(dist(mat, method = "canberra")), method = "complete"), k = 5),
        #row_split = 5,
        #row_gap = unit(1.75, 'mm'),
        border = FALSE, 
        show_row_names = FALSE,

        
       # row_names_max_width = unit(50, "mm"), #Does not appear to be doing anything
       right_annotation = rowAnnotation(
            Col1 = anno_text(TnT_List_Analysis_Shrunk2$locus, location = unit(0.75, "mm"), gp = gpar(fontsize = RowLabelTextCell)), 
            Col2 = anno_text(TnT_List_Analysis_Shrunk2$Gene, location = unit(1.5, "mm"), gp = gpar(fontsize = RowLabelTextCell)),
          	# Col3 = anno_text(TnT_List_Analysis_Shrunk2$PAO1_ID, location = unit(0, "mm"), gp = gpar(fontsize = RowLabelTextCell)),
            gap = unit(6, "mm")),

        
        
        row_title = "Transcribed Gene Loci",
        row_order = RowOrder,
        row_names_gp = gpar(fontsize = RowLabelTextCell),
        row_dend_reorder = FALSE,
        
        
        cell_fun = function(j, i, x, y, width, height, fill) {
          if(mat[i, j] < 0 || mat[i, j] > 0)
            grid.text(sprintf("%.1f", mat[i, j]), x, y, gp = gpar(fontsize = InCellTextSize))},
        
       
        column_dend_reorder = FALSE, 
        column_order = ColOrder, 
        column_names_rot = 90,
        column_names_gp = gpar(fontsize = ColumnLabelText),
        
        
        column_title = "Conditions tested (CF39S vs CF39)",
        column_title_gp = gpar(fontsize = RowLabelTextCell),
        column_title_side = "bottom",
        
        
        #row_dend_width = unit(3.1, "cm"),

        heatmap_legend_param = list(title = LegendName),
       
        col = colorSetRedBlue,
        # height = unit(12, 'cm'),
       raster_quality = 10
        )
#HeatmapTest <- draw(HeatmapTest, heatmap_legend_side = "bottom", annotation_legend_side = "bottom")


HeatmapTest
```




```{r}
pdf("heatmap_Canberra(mat)AsDend_colored_split_CellLabled_TnT_FullSpread.pdf", width = 9, height = 12)
HeatmapTest
dev.off()
```

```{r}
png("heatmap_Canberra(mat)AsDend_colored_split_CellLabled_TnT_FullSpread.png", width = 15, height = 12, units = "cm", res = 300)
HeatmapTest
dev.off()
```


#Session Info
```{r}
sink(file = "./SessionInfo.txt")
sessionInfo()
sink(file = NULL)
```


#References

The citation function can be used to  who you should be citing.

```{r}
sink(file = "./ReferenceInfo.txt")
citation("readr")
citation("ComplexHeatmap")
citation("circlize")
citation("cluster")
sink(file = NULL)
```
